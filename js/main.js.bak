/**
 * @file main.js
 * @description ê²Œìž„ì˜ ì—”íŠ¸ë¦¬ í¬ì¸íŠ¸. ëª¨ë“  View ë° Managerë¥¼ ì´ˆê¸°í™”í•˜ê³  ì—°ê²°í•©ë‹ˆë‹¤.
 */
import './debug_overlay.js'; // [DEBUG] ë””ë²„ê¹… ì˜¤ë²„ë ˆì´ ì¶”ê°€
import Game from './core/Game.js';
import { LangManager } from './managers/LanguageManager.js';
import UIManager from './managers/UIManager.js';

// ê° í™”ë©´ë³„ View ìž„í¬íŠ¸
import AuthView from './ui/AuthView.js';
import CreatureView from './ui/CreatureView.js';
import SummonView from './ui/SummonView.js';
import ExpeditionView from './ui/ExpeditionView.js';
import ResearchView from './ui/ResearchView.js';
import TeamView from './ui/TeamView.js';
import MissionView from './ui/MissionView.js';
import ShopView from './ui/ShopView.js';
import BattleView from './ui/BattleView.js';
import PrestigeView from './ui/PrestigeView.js'; // [NEW]

document.addEventListener('DOMContentLoaded', () => {
    console.log("Multiverse Creature Lab - Phase 4 Refactored");

    // 1. í•µì‹¬ ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
    const game = new Game();
    const langManager = new LangManager();
    const uiManager = new UIManager(game);

    // 2. ì–¸ì–´ ì„¤ì • ì—°ë™ (ìƒì„±ìžì—ì„œ ì´ˆê¸°í™”ë¨)
    // langManager.init();

    // 3. í™”ë©´ë³„ View ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì´ˆê¸°í™”
    // (AuthViewëŠ” LangManagerê°€ í•„ìš”í•˜ë¯€ë¡œ ë³„ë„ ì „ë‹¬)
    const views = {
        auth: new AuthView(game, uiManager, langManager),
        creature: new CreatureView(game, uiManager),
        summon: new SummonView(game, uiManager),
        expedition: new ExpeditionView(game, uiManager),
        research: new ResearchView(game, uiManager),
        team: new TeamView(game, uiManager),
        mission: new MissionView(game, uiManager),
        shop: new ShopView(game, uiManager),
        battle: new BattleView(game, uiManager),
        prestige: new PrestigeView(game, uiManager) // [NEW]
    };

    // ëª¨ë“  ë·° ì´ˆê¸°í™”
    Object.values(views).forEach(view => {
        if (typeof view.init === 'function') {
            view.init();
        }
    });

    // ì €ìž¥ëœ ë¡œë¹„ ìºë¦­í„° ë³µì›
    const savedLobbyCharacter = localStorage.getItem('lobbyCharacter');
    if (savedLobbyCharacter) {
        try {
            const { image, name } = JSON.parse(savedLobbyCharacter);
            const lobbyImg = document.getElementById('lobby-character-img');
            if (lobbyImg && image) {
                lobbyImg.src = image;
                lobbyImg.alt = name;
            }
        } catch (e) {
            console.error('ë¡œë¹„ ìºë¦­í„° ë³µì› ì‹¤íŒ¨:', e);
        }
    }

    // ë¡œë¹„ í„°ì¹˜ ìƒí˜¸ìž‘ìš© ì´ˆê¸°í™”
    uiManager.initLobbyInteraction();

    // 4. ì „ì—­ ì ‘ê·¼ì„± í™•ë³´ (ë””ë²„ê·¸ ë° ìƒìœ„ ë¡œì§ìš©)
    window.uiManager = uiManager;
    window.views = views;
    window.game = game; // [Debug] ê²Œìž„ ì¸ìŠ¤í„´ìŠ¤ ë…¸ì¶œ

    // [Dev Mode Toggle] Numpad 0
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Numpad0') {
            const devControls = document.getElementById('dev-controls');
            if (devControls) {
                devControls.style.display = devControls.style.display === 'none' ? 'block' : 'none';
                console.log(`[DevMode] Controls ${devControls.style.display}`);
            }
        }
    });

    // 5. ê²Œìž„ ì—”ì§„ ì´ˆê¸°í™”
    // (ì£¼ì˜: UIê°€ ì¤€ë¹„ëœ í›„ game.initì„ í˜¸ì¶œí•˜ì—¬ ì´ˆê¸° ë Œë”ë§ì´ ì •ìƒ ìž‘ë™í•˜ê²Œ í•¨)
    game.init();

    // 6. ë¦¬ì†ŒìŠ¤ë°” ì‹¤ì‹œê°„ ë™ê¸°í™” (ì „ì—­ ë¦¬ìŠ¤ë„ˆ)
    game.resourceManager.on('resources:changed', (res) => {
        if (uiManager.ui.goldDisplay) uiManager.ui.goldDisplay.innerText = res.gold.toLocaleString();
        if (uiManager.ui.gemDisplay) uiManager.ui.gemDisplay.innerText = res.gem.toLocaleString();
        if (uiManager.ui.energyDisplay) {
            uiManager.ui.energyDisplay.innerText = `${res.energy} / ${res.maxEnergy}`;
        }
    });

    // 7. ì‹œìŠ¤í…œ ì„¤ì • ëª¨ë‹¬ ë“± ê¸°íƒ€ ì „ì—­ UI ì œì–´
    initSystemOverlay();

    // [NEW] 8. ë¡œë¹„ ìºë¦­í„° ì¸í„°ëž™ì…˜ ì´ˆê¸°í™”
    initLobbyInteraction(game);

    // [NEW] 9. ë‹¤êµ­ì–´ í† ê¸€ ë²„íŠ¼
    const btnLangToggle = document.getElementById('btn-lang-toggle');
    if (btnLangToggle) {
        btnLangToggle.addEventListener('click', () => {
            const newLang = langManager.currentLang === 'ko' ? 'en' : 'ko';
            langManager.setLang(newLang);
            btnLangToggle.innerText = `ðŸŒ ${newLang.toUpperCase()}`;
            alert(`ì–¸ì–´ê°€ ${newLang === 'ko' ? 'í•œêµ­ì–´' : 'English'}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        });
    }
});

/**
 * ë¡œë¹„ ìºë¦­í„° ì¸í„°ëž™ì…˜ ë° í‘œì‹œ ì œì–´
 */
function initLobbyInteraction(game) {
    const wrapper = document.getElementById('lobby-character-wrapper');
    const img = document.getElementById('lobby-character-img');
    const speechBubble = document.getElementById('lobby-speech-bubble');
    const speechText = document.getElementById('lobby-speech-text');

    if (!wrapper || !img) return;

    // 1. ëŒ€í‘œ í¬ë¦¬ì²˜ ë¡œë“œ (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ or ë± 1ë²ˆ)
    function updateLobbyCharacter() {
        // [ìˆ˜ì •] 0ìˆœìœ„: ì‚¬ìš©ìžê°€ ì§ì ‘ ì„ íƒí•œ ë¡œë¹„ ìºë¦­í„° (localStorage)
        try {
            const saved = localStorage.getItem('lobbyCharacter');
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed.instanceId) {
                    const c = game.creatureManager.getCreatureById(parsed.instanceId);
                    if (c) {
                        img.src = c.def.image;
                        img.style.animation = 'none';
                        speechText.innerText = c.def.lines?.normal || "...";
                        return;
                    }
                }
            }
        } catch (e) { console.warn("Lobby restore error", e); }

        // [ìˆ˜ì •] 1ìˆœìœ„: ë©”ì¸ ë±ì˜ ë¦¬ë”
        const mainDeck = game.deckManager.getMainDeck();
        let leaderId = mainDeck ? mainDeck[0] : null;

        // [ìˆ˜ì •] 2ìˆœìœ„: ë±ë„ ì—†ê³  ì„ íƒë„ ì•ˆ í–ˆìœ¼ë©´ -> ë³´ìœ  ì¤‘ì¸ 'ê°€ìž¥ ë†’ì€ ë“±ê¸‰' í¬ë¦¬ì²˜ ìžë™ ì„ íƒ (Anti-Grot)
        if (!leaderId && game.creatureManager.owned && game.creatureManager.owned.length > 0) {
            const rarityRank = { 'UR': 7, 'SSR': 6, 'SR': 5, 'Special': 4, 'Rare': 3, 'Unique': 2, 'Normal': 1 };
            const bestCreature = [...game.creatureManager.owned].sort((a, b) => {
                const ra = rarityRank[a.def.rarity] || 0;
                const rb = rarityRank[b.def.rarity] || 0;
                return rb - ra; // ë‚´ë¦¼ì°¨ìˆœ (ë†’ì€ ë“±ê¸‰ ë¨¼ì €)
            })[0];
            leaderId = bestCreature.instanceId;

            // ìžë™ ì„ íƒëœ ì¢‹ì€ ìºë¦­í„°ë¥¼ localStorageì—ë„ ì €ìž¥í•´ë‘  (ë‹¤ìŒì— ë°”ë¡œ ëœ¨ê²Œ)
            localStorage.setItem('lobbyCharacter', JSON.stringify({
                image: bestCreature.def.image,
                name: bestCreature.def.name,
                instanceId: bestCreature.instanceId
            }));
        }

        if (!leaderId) return;

        const creature = game.creatureManager.getCreatureById(leaderId);
        if (creature) {
            img.src = creature.def.image;
            img.style.animation = 'none';
        }
    }

    // ì´ˆê¸° ë¡œë“œ ë° ë³€ê²½ ê°ì§€ (ê°„ë‹¨ížˆ 3ì´ˆë§ˆë‹¤ ì²´í¬ or ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ)
    updateLobbyCharacter();
    game.events.on('deck:updated', updateLobbyCharacter);

    // 2. í„°ì¹˜ í•¸ë“¤ëŸ¬ (HTML ID ìˆ˜ì •: touch-head, touch-body, touch-legs)
    const touchZones = [
        { id: 'touch-head', part: 'head' },
        { id: 'touch-body', part: 'chest' },
        { id: 'touch-legs', part: 'legs' }
    ];

    touchZones.forEach(({ id, part }) => {
        const zone = document.getElementById(id);
        if (zone) {
            zone.onclick = (e) => {
                // í˜„ìž¬ ë¦¬ë” ë‹¤ì‹œ ì¡°íšŒ
                // [ìˆ˜ì •] ëŒ€ì‚¬ ì¶œë ¥ ëŒ€ìƒ ì„¤ì • (ì„ íƒëœ ë¡œë¹„ ìºë¦­í„° ìš°ì„ )
                let creature = null;

                // 1. ì‚¬ìš©ìžê°€ í´ë¦­í•´ì„œ ì„ íƒí•œ ë¡œë¹„ ìºë¦­í„° í™•ì¸
                try {
                    const saved = localStorage.getItem('lobbyCharacter');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        if (parsed.instanceId) {
                            creature = game.creatureManager.getCreatureById(parsed.instanceId);
                        }
                    }
                } catch (e) { console.warn("Lobby char parse error", e); }

                // 2. ì—†ìœ¼ë©´ ë± ë¦¬ë” ì‚¬ìš© (ê¸°ì¡´ ë¡œì§)
                if (!creature) {
                    const mainDeck = game.deckManager.getMainDeck();
                    let leaderId = mainDeck ? mainDeck[0] : null;

                    // ë±ì´ ë¹„ì–´ìžˆìœ¼ë©´ ì²« ë²ˆì§¸ ì†Œìœ  í¬ë¦¬ì²˜ ì‚¬ìš©
                    if (!leaderId && game.creatureManager.owned && game.creatureManager.owned.length > 0) {
                        leaderId = game.creatureManager.owned[0].instanceId;
                    }
                    creature = leaderId ? game.creatureManager.getCreatureById(leaderId) : null;
                }

                if (!creature) {
                    speechText.innerText = "í¬ë¦¬ì²˜ë¥¼ ì†Œí™˜í•´ì£¼ì„¸ìš”.";
                    speechBubble.classList.add('active');
                    if (window.speechTimer) clearTimeout(window.speechTimer);
                    window.speechTimer = setTimeout(() => {
                        speechBubble.classList.remove('active');
                    }, 2000);
                    return;
                }

                // [í˜¸ê°ë„] ì¿¨íƒ€ìž„ ë° ìƒìŠ¹ (1ì´ˆ)
                const now = Date.now();
                if (!creature._lastTouchTime || now - creature._lastTouchTime > 1000) {
                    creature._lastTouchTime = now;
                    game.creatureManager.increaseAffection(creature.instanceId, 1);

                    // í•˜íŠ¸ ì´íŽ™íŠ¸
                    createHeartEffect(e.clientX, e.clientY);
                    console.log(`[Affection] ${creature.def.name} +1 (Total: ${creature.affection})`);
                }

                // 1. ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±°
                img.className = '';
                void img.offsetWidth;
                img.className = `touch-react-${part}`;
                setTimeout(() => img.className = '', 500);

                // 2. ëŒ€ì‚¬ ì¶œë ¥
                const lines = creature.def.lines || {};
                let text = lines.normal || "...";

                if (part === 'head') {
                    text = lines.touch_head || text;
                } else if (part === 'chest') {
                    // [NEW] ê°€ìŠ´ ëŒ€ì‚¬ ìš°ì„ , ì—†ìœ¼ë©´ special, ê·¸ê²ƒë„ ì—†ìœ¼ë©´ normal
                    text = lines.touch_chest || lines.touch_special || lines.normal;
                } else if (part === 'legs') {
                    // [NEW] ë‹¤ë¦¬ ëŒ€ì‚¬ ìš°ì„ , ì—†ìœ¼ë©´ special
                    text = lines.touch_legs || lines.touch_special || lines.normal;
                }

                // í˜¸ê°ë„ ì‹œìŠ¤í…œ ì—°ë™ ê°€ëŠ¥ (ë‚˜ì¤‘ì—)

                // ë§í’ì„  í‘œì‹œ
                speechText.innerText = text;
                speechBubble.classList.add('active');

                // 3ì´ˆ í›„ ìˆ¨ê¹€
                if (window.speechTimer) clearTimeout(window.speechTimer);
                window.speechTimer = setTimeout(() => {
                    speechBubble.classList.remove('active');
                }, 3000);
            };
        }
    });
}

/**
 * ì‹œìŠ¤í…œ ì„¤ì • ë° ê³µì§€ì‚¬í•­ ì˜¤ë²„ë ˆì´ ì œì–´
 */
function initSystemOverlay() {
    // ... (Existing code)
    const btnOpenSystem = document.getElementById('btn-system-settings');
    const btnCloseSystem = document.getElementById('btn-close-system');
    const overlay = document.getElementById('system-modal-overlay');

    if (btnOpenSystem && overlay) {
        btnOpenSystem.addEventListener('click', () => {
            overlay.style.display = 'flex';
        });
    }

    if (btnCloseSystem && overlay) {
        btnCloseSystem.addEventListener('click', () => {
            overlay.style.display = 'none';
        });
    }

    // ì‹œìŠ¤í…œ íƒ­ ì „í™˜
    const tabs = document.querySelectorAll('.system-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => {
                t.classList.remove('active');
                t.style.color = '#888';
                t.style.borderBottomColor = 'transparent';
            });
            tab.classList.add('active');
            tab.style.color = 'white';
            tab.style.borderBottomColor = 'var(--accent-cyan)';

            const target = tab.dataset.tab;
            document.getElementById('view-notice').style.display = target === 'notice' ? 'block' : 'none';
            document.getElementById('view-contact').style.display = target === 'contact' ? 'block' : 'none';
        });
    });
}

/**
 * ÇÏÆ® ÀÌÆåÆ® »ý¼º ÇÔ¼ö (È£°¨µµ¿ë)
 */
function createHeartEffect(x, y) {
    const heart = document.createElement('div');
    heart.className = 'floating-heart';
    heart.innerText = '';
    heart.style.left = x + 'px';
    heart.style.top = y + 'px';
    document.body.appendChild(heart);
    setTimeout(() => heart.remove(), 1500);
}


/**
 * Update Resonance Bar UI
 */
function updateResonanceUI(creature) {
    if (!creature) {
        const bar = document.getElementById('lobby-resonance-bar');
        if (bar) bar.style.display = 'none';
        return;
    }

    let bar = document.getElementById('lobby-resonance-bar');
    if (!bar) {
        bar = document.createElement('div');
        bar.id = 'lobby-resonance-bar';
        bar.innerHTML = \<div class='resonance-heart'></div>
            <div style='font-size:0.8rem; color:white; font-weight:bold; margin-bottom:2px; text-shadow:0 0 4px black;' id='resonance-text'></div>
            <div class='resonance-container'>
                <div class='resonance-fill' id='resonance-fill'></div>
            </div>
            <div style='font-size:0.7rem; color:#ccc; margin-top:2px; text-shadow:0 0 4px black;' id='resonance-ego'></div>\;
        const wrapper = document.getElementById('lobby-character-wrapper');
        if (wrapper) wrapper.appendChild(bar);
    }
    bar.style.display = 'flex';

    // Calculate Percent
    const score = game.creatureManager.getResonanceScore(creature);
    const level = game.creatureManager.getAffectionLevel(creature);
    const levels = { 0: 100, 1: 300, 2: 1000, 3: 2000 };
    const max = levels[level] || 2000;
    const prevMax = level > 0 ? (levels[level-1] || 0) : 0;
    
    // Percent based on current level progress
    let percent = 0;
    if (level === 3) {
        percent = 100;
    } else {
        percent = Math.max(0, Math.min(100, ((score - prevMax) / (max - prevMax)) * 100));
    }

    const labels = ['°æ°è', '°ü½É', '½Å·Ú', '¼­¾à'];
    const colors = ['#9e9e9e', '#66bb6a', '#f48fb1', '#ad1457'];
    
    bar.querySelector('#resonance-text').innerText = \\ (Lv.\)\;
    bar.querySelector('#resonance-text').style.color = colors[level];
    bar.querySelector('#resonance-fill').style.width = \\%\;
    bar.querySelector('#resonance-ego').innerText = \ Ego: \\;
}

